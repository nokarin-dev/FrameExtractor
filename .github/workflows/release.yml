name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  publish:
    name: Build & Release FrameExtractor
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        rid: [win-x64, linux-x64]
        exclude:
          - os: windows-latest
            rid: linux-x64
          - os: ubuntu-latest
            rid: win-x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Publish
        run: |
          dotnet publish FrameExtractor.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            -p:SelfContained=true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:PublishTrimmed=true \
            -p:DebugType=None \
            -p:DebugSymbols=false \
            -o publish
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
  	shell: bash
        
      - name: Prepare artifacts
        run: |
          mkdir -p release

          if [[ "${{ matrix.rid }}" == "win-x64" ]]; then
            cp publish/FrameExtractor.exe release/
          else
            cp publish/FrameExtractor release/
            chmod +x release/FrameExtractor
          fi

          # Generate SHA256 checksums
          cd release
          for file in *; do
            sha256sum "$file" > "$file.sha256"
          done
        shell: bash

      - name: Upload release artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/FrameExtractor*
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

